# 센서 Raw 데이터에서 칼만 필터까지: 실제 측정값으로 따라가는 계산 여정

> 📅 2026.02.07
> 드디어 부품들이 도착했다! 실제 센서에서 데이터가 측정되는 것을 확인하고, 이 Raw 데이터가 어떻게 최종 위치 추정까지 이어지는지 계산 과정을 정리해본다.

---

## 1. 실제 측정 데이터 확인

각 센서 모듈을 연결하고 시리얼 모니터로 데이터가 정상적으로 출력되는지 확인했다.

### 📍 GPS (GY-GPSV3-NEO-M8N)

```
37.556165  126.937189
```

- 위도: **37.556165°** (북위)
- 경도: **126.937189°** (동경)
- 서울 지역의 좌표가 정상적으로 출력됨

### 🔄 IMU (MPU-9250) - 가속도계

```
X:-0.10 Y:0.06 Z:0.84
X:-0.07 Y:-0.04 Z:0.76
X:-0.08 Y:0.02 Z:0.79
X:-0.13 Y:-0.03 Z:0.86
X:-0.15 Y:0.03 Z:0.89
X:-0.17 Y:0.04 Z:0.96
```

- **X, Y축**: 거의 0에 가까움 → 수평 상태 유지 중
- **Z축**: 약 0.8~0.96 → 중력 가속도(1g = 9.8m/s²)를 g 단위로 표시
- 센서가 이미 g 단위로 변환된 값을 출력하고 있음

### ❤️ 심박 센서 (MAX30102)

```
IR=78709 | BPM=5.65 | 평균 BPM=108
IR=79875 | BPM=5.65 | 평균 BPM=108
IR=80778 | BPM=5.65 | 평균 BPM=108
```

- **IR**: PPG(광혈류) Raw 신호값 (피크 검출용)
- **BPM**: 순간 심박수 (현재는 안정화 중이라 낮게 표시)
- **평균 BPM**: 이동 평균 심박수 → **108 BPM** 

---

## 2. 계산 프로세스: Raw → 물리 단위 → 칼만 필터

이제 측정된 데이터가 어떤 과정을 거쳐 최종 위치 추정에 사용되는지 단계별로 따라가보자.

### Step 1: GPS 좌표 → 로컬 미터 좌표 변환

**왜 변환이 필요한가?**

칼만 필터는 "미터" 단위로 계산한다. GPS의 위도/경도(도 단위)는 그대로 사용 불가.

```
변환 공식:
─────────────────────────────────────────────────
Δx = (lon₂ - lon₁) × cos(lat) × 111,320 m
Δy = (lat₂ - lat₁) × 111,320 m

※ 111,320 = 지구 둘레(40,075km) ÷ 360°
※ cos(lat)는 위도가 높아질수록 경도 1도의 거리가 줄어드는 것을 보정
```

#### 실제 계산 예시

측정된 좌표: **(37.556165°, 126.937189°)**

**기준점 설정** (운동 시작 위치라고 가정):

- 기준 위도: 37.556100°
- 기준 경도: 126.937100°

**1. cos(위도) 미리 계산:**

```
cos(37.556165° × π/180) ==> cos(0.6554 rad) ==> 0.7930
```

**2. X 좌표 (동서 방향) 계산:**

```
Δlon = 126.937189 - 126.937100 = 0.000089°

Δx = 0.000089 × 0.7930 × 111,320
   = 0.000089 × 88,277.36
   = 7.86 m (동쪽으로 약 7.9m)
```

**3. Y 좌표 (남북 방향) 계산:**

```
Δlat = 37.556165 - 37.556100 = 0.000065°

Δy = 0.000065 × 111,320
   = 7.24 m (북쪽으로 약 7.2m)
```

**결과: "운동 시작점에서 얼마나 떨어졌는지"**

```
로컬 좌표: (x = 7.86 m, y = 7.24 m)
```

>  **핵심**: GPS 좌표가 아무리 정확해도, 이 좌표계 변환이 잘못되면 칼만 필터 자체가 무의미하다!

---

### Step 2: IMU 데이터 → 물리 단위 변환

측정된 IMU 데이터 (대표값):

```
X: -0.10 g
Y:  0.06 g  
Z:  0.84 g
```

> 현재 센서가 이미 g 단위로 출력하고 있어서, m/s² 변환만 필요

#### g → m/s² 변환 계산

```
변환 공식:
─────────────────────────────────────────────────
가속도 (m/s²) = 가속도 (g) × 9.80665

※ 9.80665 = 표준 중력 가속도
```

**실제 계산:**

```
ax = -0.10 g × 9.80665 = -0.981 m/s²  (뒤쪽으로 감속)
ay =  0.06 g × 9.80665 =  0.588 m/s²  (오른쪽으로 기울어짐)
az =  0.84 g × 9.80665 =  8.238 m/s²  (중력 방향, 약간 기울어진 상태)
```

**결과 벡터:**

```
         ┌──────────────┐
         │ ax = -0.981  │ m/s² (X축)
 u_k =   │ ay =  0.588  │ m/s² (Y축)
         │ az =  8.238  │ m/s² (Z축)
         └──────────────┘
```

> ⚠️ **주의**: Z축이 9.8이 아니라 8.2인 이유는 센서가 완전히 수평이 아니기 때문!
> 완전 수평 상태: Z ≈ 9.8 m/s², X ≈ Y ≈ 0

---

### Step 3: 좌표 회전 (Body Frame → Global Frame)

**왜 필요한가?**

센서가 측정하는 가속도는 **기기 기준(Body Frame)**이다.
기기가 45° 돌아가 있으면, 앞으로 가속했는데 센서는 "오른쪽으로 가속"으로 인식!

```
회전 변환 공식 (2D):
─────────────────────────────────────────────────

┌             ┐   ┌                   ┐   ┌      ┐
│ ax_global   │   │  cos(θ)   -sin(θ) │   │ ax   │
│             │ = │                   │ × │      │
│ ay_global   │   │  sin(θ)    cos(θ) │   │ ay   │
└             ┘   └                   ┘   └      ┘

풀어쓰면:
ax_global = ax × cos(θ) - ay × sin(θ)
ay_global = ax × sin(θ) + ay × cos(θ)
```

#### 실제 계산 예시

현재 방향: **θ = 0.1 rad ≈ 5.7°** (약간 왼쪽으로 회전한 상태)

```
cos(0.1) = 0.995
sin(0.1) = 0.0998
```

**Global 좌표로 변환:**

```
ax_global = (-0.981) × 0.995 - (0.588) × 0.0998
          = -0.976 - 0.059
          = -1.035 m/s²

ay_global = (-0.981) × 0.0998 + (0.588) × 0.995
          = -0.098 + 0.585
          = 0.487 m/s²
```

**결과:**

```
기기 기준:   ax = -0.981,  ay = 0.588
  ↓ (5.7° 회전 보정)
세계 기준:   ax = -1.035,  ay = 0.487
```

---

### Step 4: 칼만 필터 예측 단계 (Predict)

**상태 벡터 (우리가 추정하고 싶은 것들):**

```
         ┌─────┐
         │ px  │ ← X 위치 (어디에 있나?)
         │ py  │ ← Y 위치
x     =  │ vx  │ ← X 속도 (얼마나 빨리 가나?)
         │ vy  │ ← Y 속도
         │ θ   │ ← 방향 (어디를 보고 있나?)
         └─────┘
```

**예측 공식 (등가속도 운동):**

```
위치:  p = p_prev + v × Δt + ½ × a × Δt²
속도:  v = v_prev + a × Δt
방향:  θ = θ_prev + ω × Δt
```

#### 🧮 실제 계산 예시

**초기 상태:**

- 위치: (7.86 m, 7.24 m)
- 속도: (1.5 m/s, 0.5 m/s) - 앞으로 걷는 중
- 방향: 0.1 rad

**입력값:**

- 가속도: ax_global = -1.035 m/s², ay_global = 0.487 m/s²
- 각속도: ωz = 0.05 rad/s (천천히 왼쪽으로 회전)
- Δt = 0.01초 (100Hz 샘플링)

**계산:**

```
1. 위치 예측:
   px_new = 7.86 + 1.5 × 0.01 + 0.5 × (-1.035) × 0.01²
          = 7.86 + 0.015 - 0.00005
          = 7.875 m

   py_new = 7.24 + 0.5 × 0.01 + 0.5 × 0.487 × 0.01²
          = 7.24 + 0.005 + 0.00002
          = 7.245 m

2. 속도 예측:
   vx_new = 1.5 + (-1.035) × 0.01 = 1.4897 m/s
   vy_new = 0.5 + 0.487 × 0.01   = 0.5049 m/s

3. 방향 예측:
   θ_new = 0.1 + 0.05 × 0.01 = 0.1005 rad
```

**예측 결과:**

```
         ┌────────────┐
         │ px = 7.875 │ m
         │ py = 7.245 │ m
x̂     =  │ vx = 1.490 │ m/s
         │ vy = 0.505 │ m/s
         │ θ  = 0.101 │ rad
         └────────────┘
```

---

### 📡 Step 5: 칼만 필터 보정 단계 (Update)

GPS에서 새로운 측정이 들어왔다!

**GPS 측정값:** (7.90 m, 7.30 m) - 예측보다 살짝 동북쪽

#### 🧮 잔차(Residual) 계산

```
잔차 = 측정값 - 예측값

y = [7.90 - 7.875,  7.30 - 7.245]
  = [0.025,  0.055]
```

GPS가 예측보다 **2.5cm 동쪽, 5.5cm 북쪽**이라고 주장!

#### 🧮 칼만 이득(Kalman Gain) 적용

```
칼만 이득 K의 의미:
─────────────────────────────────────────────────
K ≈ 0.02 → GPS를 2%만 신뢰, 센서 예측을 98% 신뢰

보정 공식:
x_보정 = x_예측 + K × 잔차
```

**최종 보정:**

```
px_final = 7.875 + 0.02 × 0.025 = 7.8755 m
py_final = 7.245 + 0.02 × 0.055 = 7.2461 m
```

> 💡 **핵심**: GPS가 "7.90m라고!" 해도 칼만 필터는 "그래, 근데 센서는 7.875라고 하는데?
> 둘 다 고려해서... **7.8755m**가 제일 그럴듯하다!"라고 판단

---

## 3. 심박 데이터 처리

### ❤️ PPG → BPM 변환

**측정 데이터:**

```
IR=78709 | 평균 BPM=108
IR=79875 | 평균 BPM=108  
IR=80778 | 평균 BPM=108
```

**BPM 계산 원리:**

```
1. IR 신호에서 피크(심장 박동) 검출
2. 피크 간격 (RR Interval) 측정
3. BPM = 60 ÷ RR간격(초)

예시:
RR 간격 = 0.556초
BPM = 60 ÷ 0.556 = 108 BPM ✅
```

**심박 존(Zone) 판정:**

| Zone | 심박수 범위 | 운동 강도   | 점수 배율 |
| ---- | ----------- | ----------- | --------- |
| 1    | < 100 BPM   | 휴식        | ×1.0     |
| 2    | 100-120 BPM | 가벼운 운동 | ×1.2     |
| 3    | 120-140 BPM | 유산소      | ×1.5     |
| 4    | 140-160 BPM | 고강도      | ×2.0     |
| 5    | > 160 BPM   | 최대        | ×2.5     |

**현재 상태: 108 BPM → Zone 2 (×1.2 배율)**

---

## 4. 전체 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       🔄 데이터 처리 파이프라인                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [GPS 모듈]           [IMU 센서]              [심박 센서]                 │
│  37.556165°           X:-0.10g                 IR=79875                  │
│  126.937189°          Y:0.06g                  BPM=108                   │
│       │               Z:0.84g                       │                    │
│       ▼                   │                         │                    │
│  ① 좌표 변환              ▼                         ▼                    │
│  (7.86m, 7.24m)      ② 단위 변환              ⑤ 존 판정                  │
│       │              ax=-0.98 m/s²             Zone 2                    │
│       │              ay=0.59 m/s²              배율 ×1.2                 │
│       │                   │                         │                    │
│       │                   ▼                         │                    │
│       │              ③ 좌표 회전                    │                    │
│       │              (Body→Global)                  │                    │
│       │                   │                         │                    │
│       └────────┬──────────┘                         │                    │
│                ▼                                    │                    │
│           ┌─────────┐                               │                    │
│           │ 칼만    │◀──────────────────────────────┘                    │
│           │ 필터    │  (심박 -> 게임 로직에 사용)                          │
│           └────┬────┘                                                    │
│                ▼                                                         │
│         📍 보정된 위치                                                    │
│         (7.8755m, 7.2461m)                                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 다음 단계

- [X] GPS 모듈 연결 및 좌표 수신 확인
- [X] IMU 센서 가속도 데이터 수신 확인
- [X] 심박 센서 BPM 출력 확인
- [ ] 모든 센서 데이터를 ESP32에서 통합
- [ ] 실시간 칼만 필터 구현 (C언어)
- [ ] BLE로 스마트폰 앱에 데이터 전송
- [ ] 영역 정복 게임 로직 구현
